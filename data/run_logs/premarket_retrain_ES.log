
ML_ALL_PROGRESS 1/1 (ES)

============================================================
  Retraining ML model for ES
============================================================

2026-02-24 07:50:09.859 | INFO     | __main__:main:1034 - Loaded 94 trades from C:\Apps\trading_bot\data\backtest_ES_2020-01-01_2025-12-31.csv
2026-02-24 07:50:09.969 | INFO     | __main__:main:1034 - Loaded 710 trades from C:\Apps\trading_bot\data\backtest_ES_2020-01-01_2026-02-21.csv
2026-02-24 07:50:10.065 | INFO     | __main__:main:1034 - Loaded 93 trades from C:\Apps\trading_bot\data\backtest_ES_2020-01-03_2025-12-31.csv
2026-02-24 07:50:10.168 | INFO     | __main__:main:1034 - Loaded 552 trades from C:\Apps\trading_bot\data\backtest_ES_20200101_20251231.csv
2026-02-24 07:50:10.349 | INFO     | __main__:main:1034 - Loaded 59 trades from C:\Apps\trading_bot\data\backtest_ES_2022-01-03_2024-12-31.csv
2026-02-24 07:50:10.457 | INFO     | __main__:main:1034 - Loaded 95 trades from C:\Apps\trading_bot\data\backtest_ES_2022-01-03_2025-12-31.csv
2026-02-24 07:50:10.554 | INFO     | __main__:main:1034 - Loaded 187 trades from C:\Apps\trading_bot\data\backtest_ES_20240101_20251231.csv
2026-02-24 07:50:10.655 | INFO     | __main__:main:1034 - Loaded 44 trades from C:\Apps\trading_bot\data\wfa_trades_ES.csv
2026-02-24 07:50:10.657 | INFO     | __main__:main:1043 - Total: 1834 trades from 8 files
2026-02-24 07:50:10.659 | INFO     | __main__:main:1048 - Trades with features_json: 1834/1834 (100%)

=== Step 1/3: Labelling trades ===
2026-02-24 07:50:11.065 | DEBUG    | src.labeling.labeler:from_trade_log:171 - realized_R recomputed from raw columns
2026-02-24 07:50:11.067 | INFO     | src.labeling.labeler:from_trade_log:199 - Labeling (realized_R_binary): 949 positive / 885 negative  imbalance=51.7%
2026-02-24 07:50:11.457 | INFO     | __main__:main:1131 - Labels: 949 positive (TP), 885 negative (SL/EOD) → saved to C:\Apps\trading_bot\data\labelled_trades.csv

=== Step 2/3: Training ensemble models (combined + per-setup-type) ===
2026-02-24 07:50:11.765 | DEBUG    | src.labeling.labeler:from_trade_log:171 - realized_R recomputed from raw columns
2026-02-24 07:50:11.767 | INFO     | src.labeling.labeler:from_trade_log:199 - Labeling (realized_R_binary): 949 positive / 885 negative  imbalance=51.7%
2026-02-24 07:50:12.966 | INFO     | __main__:prepare_dataset:591 - Dataset (combined): 1834 samples, 57 features, 51.7% positive labels
  Training combined model (1834 samples)...
2026-02-24 07:50:42.163 | INFO     | __main__:train:629 - LightGBM not installed — XGBoost only. pip install lightgbm
2026-02-24 07:50:42.180 | WARNING  | src.cv.purged_time_series_split:split:150 - Fold 1: all training samples purged — skipping fold
2026-02-24 07:50:42.180 | WARNING  | src.cv.purged_time_series_split:split:150 - Fold 2: all training samples purged — skipping fold
2026-02-24 07:50:42.181 | WARNING  | src.cv.purged_time_series_split:split:150 - Fold 3: all training samples purged — skipping fold
2026-02-24 07:50:42.181 | WARNING  | src.cv.purged_time_series_split:split:150 - Fold 4: all training samples purged — skipping fold
2026-02-24 07:50:42.181 | WARNING  | src.cv.purged_time_series_split:split:150 - Fold 5: all training samples purged — skipping fold
C:\Apps\trading_bot\venv\Lib\site-packages\xgboost\training.py:200: UserWarning: [07:50:42] WARNING: C:\actions-runner\_work\xgboost\xgboost\src\learner.cc:782:
Parameters: { "use_label_encoder" } are not used.

  bst.update(dtrain, iteration=i, fobj=obj)
2026-02-24 07:50:44.065 | INFO     | __main__:train:728 - Isotonic calibrator fitted on 366 holdout samples
C:\Apps\trading_bot\venv\Lib\site-packages\xgboost\training.py:200: UserWarning: [07:50:44] WARNING: C:\actions-runner\_work\xgboost\xgboost\src\learner.cc:782:
Parameters: { "use_label_encoder" } are not used.

  bst.update(dtrain, iteration=i, fobj=obj)
2026-02-24 07:50:46.052 | INFO     | __main__:train:737 - XGBoost model saved: C:\Apps\trading_bot\data\models\active\ml_filter_ES.pkl
2026-02-24 07:50:46.053 | INFO     | __main__:train:757 - Calibrator saved: C:\Apps\trading_bot\data\models\active\ml_filter_ES_COMBINED.CALIBRATOR.pkl
2026-02-24 07:50:46.252 | INFO     | __main__:train:786 - EV policy from training data: avg_R_win=1.680  avg_R_loss=-0.594  (n_wins=1023 n_losses=811)
2026-02-24 07:50:46.254 | INFO     | __main__:_save_manifest:149 - Manifest saved: C:\Apps\trading_bot\data\models\active\ml_filter_ES_manifest.json
  Combined model: AUC=0.000  marginal
2026-02-24 07:50:46.472 | DEBUG    | src.labeling.labeler:from_trade_log:171 - realized_R recomputed from raw columns
2026-02-24 07:50:46.473 | INFO     | src.labeling.labeler:from_trade_log:199 - Labeling (realized_R_binary): 949 positive / 885 negative  imbalance=51.7%
2026-02-24 07:50:46.474 | INFO     | __main__:prepare_dataset:530 - Filtering dataset to setup_type=BREAK_RETEST: 1331 / 1834 trades
2026-02-24 07:50:46.957 | INFO     | __main__:prepare_dataset:591 - Dataset (BREAK_RETEST): 1331 samples, 57 features, 54.5% positive labels
  Training BREAK_RETEST specialist (1331 samples)...
2026-02-24 07:50:46.957 | INFO     | __main__:train:629 - LightGBM not installed — XGBoost only. pip install lightgbm
2026-02-24 07:50:46.957 | WARNING  | src.cv.purged_time_series_split:split:150 - Fold 1: all training samples purged — skipping fold
2026-02-24 07:50:46.957 | WARNING  | src.cv.purged_time_series_split:split:150 - Fold 2: all training samples purged — skipping fold
2026-02-24 07:50:46.957 | WARNING  | src.cv.purged_time_series_split:split:150 - Fold 3: all training samples purged — skipping fold
2026-02-24 07:50:46.957 | WARNING  | src.cv.purged_time_series_split:split:150 - Fold 4: all training samples purged — skipping fold
2026-02-24 07:50:46.957 | WARNING  | src.cv.purged_time_series_split:split:150 - Fold 5: all training samples purged — skipping fold
C:\Apps\trading_bot\venv\Lib\site-packages\xgboost\training.py:200: UserWarning: [07:50:46] WARNING: C:\actions-runner\_work\xgboost\xgboost\src\learner.cc:782:
Parameters: { "use_label_encoder" } are not used.

  bst.update(dtrain, iteration=i, fobj=obj)
2026-02-24 07:50:48.557 | INFO     | __main__:train:728 - Isotonic calibrator fitted on 266 holdout samples
C:\Apps\trading_bot\venv\Lib\site-packages\xgboost\training.py:200: UserWarning: [07:50:48] WARNING: C:\actions-runner\_work\xgboost\xgboost\src\learner.cc:782:
Parameters: { "use_label_encoder" } are not used.

  bst.update(dtrain, iteration=i, fobj=obj)
2026-02-24 07:50:50.461 | INFO     | __main__:train:737 - XGBoost model saved: C:\Apps\trading_bot\data\models\active\ml_filter_ES_BREAK_RETEST.pkl
2026-02-24 07:50:50.462 | INFO     | __main__:train:757 - Calibrator saved: C:\Apps\trading_bot\data\models\active\ml_filter_ES_BREAK_RETEST.CALIBRATOR.pkl
2026-02-24 07:50:50.561 | INFO     | __main__:train:786 - EV policy from training data: avg_R_win=1.692  avg_R_loss=-0.644  (n_wins=694 n_losses=637)
2026-02-24 07:50:50.563 | INFO     | __main__:_save_manifest:149 - Manifest saved: C:\Apps\trading_bot\data\models\active\ml_filter_ES_BREAK_RETEST_manifest.json
    BREAK_RETEST: AUC=0.000  marginal
2026-02-24 07:50:51.051 | DEBUG    | src.labeling.labeler:from_trade_log:171 - realized_R recomputed from raw columns
2026-02-24 07:50:51.051 | INFO     | src.labeling.labeler:from_trade_log:199 - Labeling (realized_R_binary): 949 positive / 885 negative  imbalance=51.7%
2026-02-24 07:50:51.051 | INFO     | __main__:prepare_dataset:530 - Filtering dataset to setup_type=REJECTION: 0 / 1834 trades
2026-02-24 07:50:51.051 | DEBUG    | __main__:prepare_dataset:544 - Not enough trades for setup_type=REJECTION: 0 rows — returning empty dataset
  REJECTION: only 0 samples — skipping specialist model
2026-02-24 07:50:51.285 | DEBUG    | src.labeling.labeler:from_trade_log:171 - realized_R recomputed from raw columns
2026-02-24 07:50:51.286 | INFO     | src.labeling.labeler:from_trade_log:199 - Labeling (realized_R_binary): 949 positive / 885 negative  imbalance=51.7%
2026-02-24 07:50:51.287 | INFO     | __main__:prepare_dataset:530 - Filtering dataset to setup_type=BOUNCE: 13 / 1834 trades
2026-02-24 07:50:51.290 | INFO     | __main__:prepare_dataset:591 - Dataset (BOUNCE): 13 samples, 57 features, 84.6% positive labels
  Training BOUNCE specialist (13 samples)...
2026-02-24 07:50:51.290 | INFO     | __main__:train:629 - LightGBM not installed — XGBoost only. pip install lightgbm
2026-02-24 07:50:51.348 | WARNING  | src.cv.purged_time_series_split:split:150 - Fold 1: all training samples purged — skipping fold
2026-02-24 07:50:51.348 | WARNING  | src.cv.purged_time_series_split:split:150 - Fold 2: all training samples purged — skipping fold
C:\Apps\trading_bot\venv\Lib\site-packages\xgboost\training.py:200: UserWarning: [07:50:51] WARNING: C:\actions-runner\_work\xgboost\xgboost\src\learner.cc:782:
Parameters: { "use_label_encoder" } are not used.

  bst.update(dtrain, iteration=i, fobj=obj)
C:\Apps\trading_bot\venv\Lib\site-packages\xgboost\training.py:200: UserWarning: [07:50:51] WARNING: C:\actions-runner\_work\xgboost\xgboost\src\learner.cc:782:
Parameters: { "use_label_encoder" } are not used.

  bst.update(dtrain, iteration=i, fobj=obj)
2026-02-24 07:50:52.055 | INFO     | __main__:train:737 - XGBoost model saved: C:\Apps\trading_bot\data\models\active\ml_filter_ES_BOUNCE.pkl
2026-02-24 07:50:52.158 | INFO     | __main__:train:786 - EV policy from training data: avg_R_win=2.129  avg_R_loss=-0.750  (n_wins=13 n_losses=0)
2026-02-24 07:50:52.160 | INFO     | __main__:_save_manifest:149 - Manifest saved: C:\Apps\trading_bot\data\models\active\ml_filter_ES_BOUNCE_manifest.json
    BOUNCE: AUC=0.000  marginal
2026-02-24 07:50:52.556 | DEBUG    | src.labeling.labeler:from_trade_log:171 - realized_R recomputed from raw columns
2026-02-24 07:50:52.556 | INFO     | src.labeling.labeler:from_trade_log:199 - Labeling (realized_R_binary): 949 positive / 885 negative  imbalance=51.7%
2026-02-24 07:50:52.556 | INFO     | __main__:prepare_dataset:530 - Filtering dataset to setup_type=SWEEP_REVERSE: 490 / 1834 trades
2026-02-24 07:50:52.753 | INFO     | __main__:prepare_dataset:591 - Dataset (SWEEP_REVERSE): 490 samples, 57 features, 43.3% positive labels
  Training SWEEP_REVERSE specialist (490 samples)...
2026-02-24 07:50:52.753 | INFO     | __main__:train:629 - LightGBM not installed — XGBoost only. pip install lightgbm
2026-02-24 07:50:52.754 | WARNING  | src.cv.purged_time_series_split:split:150 - Fold 1: all training samples purged — skipping fold
2026-02-24 07:50:52.755 | WARNING  | src.cv.purged_time_series_split:split:150 - Fold 2: all training samples purged — skipping fold
2026-02-24 07:50:52.755 | WARNING  | src.cv.purged_time_series_split:split:150 - Fold 3: all training samples purged — skipping fold
2026-02-24 07:50:52.755 | WARNING  | src.cv.purged_time_series_split:split:150 - Fold 4: all training samples purged — skipping fold
2026-02-24 07:50:52.755 | WARNING  | src.cv.purged_time_series_split:split:150 - Fold 5: all training samples purged — skipping fold
C:\Apps\trading_bot\venv\Lib\site-packages\xgboost\training.py:200: UserWarning: [07:50:52] WARNING: C:\actions-runner\_work\xgboost\xgboost\src\learner.cc:782:
Parameters: { "use_label_encoder" } are not used.

  bst.update(dtrain, iteration=i, fobj=obj)
2026-02-24 07:50:53.669 | INFO     | __main__:train:728 - Isotonic calibrator fitted on 98 holdout samples
C:\Apps\trading_bot\venv\Lib\site-packages\xgboost\training.py:200: UserWarning: [07:50:53] WARNING: C:\actions-runner\_work\xgboost\xgboost\src\learner.cc:782:
Parameters: { "use_label_encoder" } are not used.

  bst.update(dtrain, iteration=i, fobj=obj)
2026-02-24 07:50:54.862 | INFO     | __main__:train:737 - XGBoost model saved: C:\Apps\trading_bot\data\models\active\ml_filter_ES_SWEEP_REVERSE.pkl
2026-02-24 07:50:54.863 | INFO     | __main__:train:757 - Calibrator saved: C:\Apps\trading_bot\data\models\active\ml_filter_ES_SWEEP_REVERSE.CALIBRATOR.pkl
2026-02-24 07:50:54.959 | INFO     | __main__:train:786 - EV policy from training data: avg_R_win=1.858  avg_R_loss=-0.665  (n_wins=289 n_losses=201)
2026-02-24 07:50:54.962 | INFO     | __main__:_save_manifest:149 - Manifest saved: C:\Apps\trading_bot\data\models\active\ml_filter_ES_SWEEP_REVERSE_manifest.json
    SWEEP_REVERSE: AUC=0.000  marginal

=== Step 3/3: Evaluating combined filter performance ===
Traceback (most recent call last):
  File "C:\Apps\trading_bot\src\ml_filter.py", line 1191, in <module>
    main()
  File "C:\Apps\trading_bot\src\ml_filter.py", line 1168, in main
    eval_metrics = ml.evaluate_filtering(X, y, trades_df)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Apps\trading_bot\src\ml_filter.py", line 872, in evaluate_filtering
    probs = self._model.predict_proba(X)[:, 1]
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Apps\trading_bot\venv\Lib\site-packages\xgboost\sklearn.py", line 1921, in predict_proba
    class_probs = super().predict(
                  ^^^^^^^^^^^^^^^^
  File "C:\Apps\trading_bot\venv\Lib\site-packages\xgboost\core.py", line 751, in inner_f
    return func(**kwargs)
           ^^^^^^^^^^^^^^
  File "C:\Apps\trading_bot\venv\Lib\site-packages\xgboost\sklearn.py", line 1446, in predict
    predts = self.get_booster().inplace_predict(
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Apps\trading_bot\venv\Lib\site-packages\xgboost\core.py", line 751, in inner_f
    return func(**kwargs)
           ^^^^^^^^^^^^^^
  File "C:\Apps\trading_bot\venv\Lib\site-packages\xgboost\core.py", line 2854, in inplace_predict
    self._validate_features(fns)
  File "C:\Apps\trading_bot\venv\Lib\site-packages\xgboost\core.py", line 3429, in _validate_features
    raise ValueError(msg.format(self.feature_names, feature_names))
ValueError: feature_names mismatch: ['range_pts', 'range_norm', 'price_vs_mid_norm', 'price_above_mid', 'or_range_vs_5day_avg', 'level_dist_pts', 'level_is_high', 'level_origin_asia', 'level_origin_london', 'active_highs_count', 'active_lows_count', 'level_freshness_bars', 'level_test_count', 'volume_ratio', 'volume_above_median', 'volume_trend_5', 'price_vs_ema20', 'price_above_ema20', 'atr_15m_14', 'momentum_3bar_norm', 'return_5bar_1m', 'daily_ema50_distance', 'price_above_ema50', 'hour', 'minute_of_day', 'day_of_week', 'mins_since_exec_open', 'bars_in_exec_window', 'setup_break_retest', 'setup_rejection', 'setup_bounce', 'direction_long', 'stop_dist_pts', 'target_dist_pts', 'rr_ratio', 'candle_body_ratio', 'atr_regime', 'spread_proxy', 'prev_bar_momentum', 'prev_bar_bullish', 'or_range_vs_atr', 'break_excursion_pts', 'closes_beyond_level', 'time_to_retest_bars', 'momentum_aligned', 'ema50_aligned', 'is_retest_quick', 'gap_size_norm', 'session_phase', 'vwap_distance_norm', 'price_above_vwap', 'price_vs_prev_high_norm', 'price_vs_prev_low_norm', 'above_prev_high', 'below_prev_low', 'efficiency_ratio', 'vol_state'] ['range_pts', 'range_norm', 'price_vs_mid_norm', 'price_above_mid', 'or_range_vs_5day_avg', 'level_dist_pts', 'level_is_high', 'level_origin_asia', 'level_origin_london', 'active_highs_count', 'active_lows_count', 'level_freshness_bars', 'level_test_count', 'volume_ratio', 'volume_above_median', 'volume_trend_5', 'price_vs_ema20', 'price_above_ema20', 'atr_15m_14', 'momentum_3bar_norm', 'return_5bar_1m', 'daily_ema50_distance', 'price_above_ema50', 'hour', 'minute_of_day', 'day_of_week', 'mins_since_exec_open', 'bars_in_exec_window', 'setup_break_retest', 'setup_rejection', 'setup_bounce', 'direction_long', 'stop_dist_pts', 'target_dist_pts', 'rr_ratio', 'candle_body_ratio', 'atr_regime', 'spread_proxy', 'prev_bar_momentum', 'prev_bar_bullish', 'or_range_vs_atr', 'break_excursion_pts', 'closes_beyond_level', 'time_to_retest_bars', 'momentum_aligned', 'ema50_aligned', 'is_retest_quick', 'gap_size_norm', 'session_phase', 'vwap_distance_norm', 'price_above_vwap', 'price_vs_prev_high_norm', 'price_vs_prev_low_norm', 'above_prev_high', 'below_prev_low', 'efficiency_ratio', 'vol_state', 'realized_R']
training data did not have the following fields: realized_R

[ml_retrain_all] ES finished -- exit 1

============================================================
  ALL ML RETRAINS COMPLETE
============================================================
    ES: FAIL (exit 1)
ML_ALL_DONE
